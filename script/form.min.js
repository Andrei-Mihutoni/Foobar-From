"use strict";import*as db from"../modules/db.min.mjs";import*as anim from"../modules/animation.min.mjs";import{prepareData}from"../modules/db.min.mjs";db.get(prepareData);let card=new Card({form:"#payment .card-form",container:"#payment .card-wrapper"}),card2=new Card({form:"#cart .card-form",container:"#cart .card-wrapper"}),fromLastOrder=!1;function checkLoggedIn(){null==netlifyIdentity.currentUser()?(document.querySelector("#logged-in-text").classList.remove("hidden"),document.querySelector("#order .order-total").classList.add("hidden"),document.querySelector("#last-order-wrapper").innerHTML="",document.querySelector("#quick-order-login-btn").classList.remove("hidden"),document.querySelector("#login-btn").textContent="Log In"):(document.querySelector("#order .order-total").classList.remove("hidden"),document.querySelector("#logged-in-text").classList.add("hidden"),document.querySelector("#quick-order-login-btn").classList.add("hidden"),document.querySelector("#login-btn").textContent="Log Out",document.querySelector("#cart-card-wrapper").classList.add("hidden"))}function init(){addBeerTemplates(db.getData()),document.querySelectorAll(".beer-text-wrapper .primary-btn").forEach(e=>e.addEventListener("click",learnMore)),document.querySelectorAll(".order-btn-wrapper button").forEach(e=>e.addEventListener("click",addBeerQuantity)),checkLoggedIn(),addRecommendedBeer()}function addRecommendedBeer(){let e=document.querySelectorAll("#beers .beer-wrapper"),t=Math.floor(Math.random()*e.length);document.querySelectorAll("#recommended-texts p")[Math.floor(3*Math.random())].classList.remove("hidden"),addQuickTemplateFromTemplate(e[t],"#recommended-wrapper",!1),document.querySelector("#recommended-wrapper .order-btn-wrapper").classList.add("hidden")}function learnMore(e){e.target.parentNode.parentNode.querySelector("section").classList.toggle("hidden")}function addBeerQuantity(e){let t=e.target.parentNode.querySelector(".order-amount");"+"==e.target.textContent?t.textContent=parseInt(t.textContent)+1:"-"==e.target.textContent&&parseInt(t.textContent)>=1&&(t.textContent=parseInt(t.textContent)-1),"beers"==e.target.parentNode.parentNode.parentNode.id?(addBeerToCart(e.target.parentNode.parentNode),updateCartTotal("#cart","#beer-cart-wrapper")):(changeBeerQuantity(e.target.parentNode.parentNode),updateCartTotal("#cart","#beer-cart-wrapper")),"last-order-wrapper"==e.target.parentNode.parentNode.parentNode.id&&updateCartTotal("#order","#last-order-wrapper")}function changeBeerQuantity(e){let t;const r=document.querySelectorAll("#beers .beer-wrapper");for(let o of r)e.id==o.id&&(t=o);t&&(t.querySelector(".order-amount").textContent=e.querySelector(".order-amount").textContent),0==parseInt(e.querySelector(".order-amount").textContent)&&e.parentNode.removeChild(e)}function updateCartTotal(e,t){let r=0;document.querySelectorAll(`${t} .beer-wrapper`).forEach(e=>{r+=parseInt(e.querySelector(".beer-price").textContent)*parseInt(e.querySelector(".order-amount").textContent)}),document.querySelector(`${e} .order-total h2 span`).textContent=r,updateCartNavAmount()}function updateCartNavAmount(){let e=document.querySelector("#cart-btn-amount"),t=0;document.querySelectorAll("#beer-cart-wrapper .order-amount").forEach(e=>t+=parseInt(e.textContent)),e.textContent=t,"0"==e.textContent?e.classList.add("hidden"):e.classList.remove("hidden")}
function addBeerToCart(e){let t,r=!1;const o=document.querySelectorAll("#beer-cart-wrapper .beer-wrapper");for(let n of o)n.id==e.id&&(r=!0),t=n;r?0==parseInt(e.querySelector(".order-amount").textContent)?t.parentNode.removeChild(t):t.querySelector(".order-amount").textContent=e.querySelector(".order-amount").textContent:0!=parseInt(e.querySelector(".order-amount").textContent)&&addQuickTemplateFromTemplate(e,"#beer-cart-wrapper",!0)}function addQuickTemplateFromTemplate(e,t,r){const o=document.querySelector("#beer-template-quick").content.cloneNode(!0);if(o.querySelector("h2").textContent=e.querySelector("h2").textContent,o.querySelector(".beer-type").textContent=e.querySelector(".beer-type").textContent,o.querySelector(".beer-alc").textContent=e.querySelector(".beer-alc").textContent,o.querySelector(".beer-price").textContent=e.querySelector(".beer-price").textContent,o.querySelector(".order-amount").textContent=e.querySelector(".order-amount").textContent,o.querySelector(".beer-label").src=e.querySelector(".beer-label").src,o.querySelectorAll(".order-btn-wrapper").forEach(e=>e.addEventListener("click",addBeerQuantity)),r){const t=Math.floor(Math.random()*Math.floor(300));e.id=t,o.querySelector(".beer-wrapper").id=t}document.querySelector(t).appendChild(o)}function addBeerTemplates(e){for(let t of e){const e=document.querySelector("#beer-template").content.cloneNode(!0);e.querySelector("h2").textContent=t.name,e.querySelector(".beer-type").textContent=t.category,e.querySelector(".beer-alc").textContent=t.alc,e.querySelector(".beer-desc").textContent=t.description.overallImpression,e.querySelector(".beer-label").src="/assets/labels/"+t.label.split(".")[0]+".jpg",e.querySelector(".aroma").textContent=t.description.aroma,e.querySelector(".appearance").textContent=t.description.appearance,e.querySelector(".flavor").textContent=t.description.flavor,e.querySelector(".mouthfeel").textContent=t.description.mouthfeel,e.querySelector(".overall").textContent=t.description.overallImpression,document.querySelector("#beers").appendChild(e)}}function sendOrder(e){let t=[];if(document.querySelectorAll(`${e} .beer-wrapper`).forEach(e=>{let r=e.querySelector("h2").textContent,o=e.querySelector(".order-amount").textContent;t.push({name:r,amount:o})}),console.warn("[INFO] POSTED DATA: "),console.log(t),0!=t.length){db.post(t);const e=netlifyIdentity.currentUser();null!=e&&(localStorage.setItem(e.email,JSON.stringify(t)),addPreviousOrder()),setTimeout(()=>{let e=db.getResponse();500==e.status?(document.querySelector("#order-response-text").classList.remove("hidden"),document.querySelector("#order-response-text").textContent=e.message,document.querySelector("#order-confirm-screen").classList.add("hidden")):(toggleOrderScreen("Your order has been successfuly sent",e.id),resetBeerOrders(),updateCartTotal("#cart","#beer-cart-wrapper"),document.querySelector("#order-response-text").classList.add("hidden"))},200)}return t}function addPreviousOrder(){const e=netlifyIdentity.currentUser(),t=JSON.parse(localStorage.getItem(e.email));if(console.log("[INFO] PREVIOUS ORDER FROM LOCALSTORAGE: "+localStorage.getItem(e.email)),document.querySelector("#last-order-wrapper").innerHTML="",t)for(let e of t)document.querySelectorAll("#beers .beer-wrapper").forEach(t=>{t.querySelector("h2").textContent==e.name&&addQuickTemplateFromTemplate(t,"#last-order-wrapper",!1)}),
document.querySelectorAll("#last-order-wrapper .beer-wrapper").forEach(t=>{t.querySelector("h2").textContent==e.name&&(t.querySelector(".order-amount").textContent=e.amount)});updateCartTotal("#order","#last-order-wrapper")}function resetBeerOrders(){document.querySelector("#beer-cart-wrapper").innerHTML="",document.querySelectorAll(".order-amount").forEach(e=>e.textContent=0)}function getCartBeerInfo(e){let t=document.querySelectorAll(`${e} h2`),r=document.querySelectorAll(`${e} .order-amount`),o=[],n=[];for(let e=0;e<t.length;e++)o[e]=t[e].textContent,n[e]=r[e].textContent;return{beerTitles:o,beerAmounts:n}}function toggleConfirmScreen(e){let t=document.querySelector("#order-confirm-screen");document.querySelector("#order-confirm-contents").innerHTML="";for(let t=0;t<e.beerTitles.length;t++){let r=document.createElement("p");r.textContent=e.beerTitles[t]+" x "+e.beerAmounts[t]+" pcs.",document.querySelector("#order-confirm-contents").appendChild(r),console.log(r)}t.classList.toggle("hidden")}function toggleOrderScreen(e,t){let r=document.querySelector("#order-feedback-screen");r.querySelector("h1").textContent=e,r.querySelector("p span").textContent=t,r.classList.toggle("hidden")}function toggleUnfinishedFeatureScreen(){document.querySelector("#unfinished-feature-screen").classList.toggle("hidden")}
document.querySelector("#login-btn").addEventListener("click",function(){netlifyIdentity.open()}),document.querySelector("#quick-order-login-btn").addEventListener("click",function(){netlifyIdentity.open()}),document.querySelector("#review-order").addEventListener("click",function(){toggleConfirmScreen(getCartBeerInfo("#beer-cart-wrapper"))}),document.querySelector("#review-order-back").addEventListener("click",function(){toggleConfirmScreen(getCartBeerInfo("#beer-cart-wrapper")),fromLastOrder=!1}),document.querySelector("#confirm-last-order").addEventListener("click",function(){toggleConfirmScreen(getCartBeerInfo("#last-order-wrapper")),fromLastOrder=!0}),document.querySelector("#confirm-order").addEventListener("click",function(){sendOrder(fromLastOrder?"#last-order-wrapper":"#beer-cart-wrapper"),fromLastOrder=!1}),document.querySelector("#unfinished-feature-screen button").addEventListener("click",toggleUnfinishedFeatureScreen),document.querySelector("#search-btn").addEventListener("click",toggleUnfinishedFeatureScreen),document.querySelector("#save-card-btn").addEventListener("click",toggleUnfinishedFeatureScreen),netlifyIdentity.on("login",e=>{console.log("[INFO] LOGGED IN. USER:",e.user_metadata.full_name),checkLoggedIn(),setTimeout(()=>{addPreviousOrder()},200),setTimeout(()=>{netlifyIdentity.close()},1500)}),netlifyIdentity.on("logout",()=>{console.log("[INFO] LOGGED OUT"),checkLoggedIn()}),setTimeout(()=>{init()},200);